<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Práctica de Cilium Network Policy</title>
    <style>
        /* Estilo básico para que se vea limpio, similar a GitHub */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            line-height: 1.6;
            max-width: 800px;
            margin: 40px auto;
            padding: 0 20px;
            color: #24292e;
        }
        h1, h2, h3 {
            border-bottom: 2px solid #eaecef;
            padding-bottom: .3em;
            font-weight: 600;
        }
        pre {
            background-color: #f6f8fa;
            border-radius: 6px;
            padding: 16px;
            overflow: auto;
            /* Permite que el texto se ajuste si es necesario */
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        /* Mantiene la fuente monoespaciada para el código */
        code {
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 0.9em;
            background-color: rgba(27,31,35,.05);
            border-radius: 3px;
            padding: .2em .4em;
        }
        pre > code {
            font-size: 1em;
            background-color: transparent;
            border-radius: 0;
            padding: 0;
        }
        /* Estilo para los elementos de la lista */
        ol {
            padding-left: 20px;
        }
        li {
            margin-bottom: 10px;
        }
        /* Estilos para el placeholder y la respuesta oculta */
        #respuesta-placeholder {
            padding: 20px;
            background-color: #fff8e1;
            border: 1px solid #ffecb3;
            border-radius: 6px;
            text-align: center;
            font-style: italic;
        }
    </style>
</head>
<body>

    <h1>¡Bienvenido a la Práctica de Cilium Network Policy!</h1>

    <p>La práctica es para securizar con Cilium Network Policy la comunicación entre <code>frontend</code> y <code>backend</code>, evitando que <code>hacker</code> se conecte al <code>backend</code>.</p>

    <ol>
        <li>
            <p>Preparamos el entorno para crear las <strong>Network Policy</strong>:</p>
            <pre><code class="language-yaml">
apiVersion: v1
kind: Namespace
metadata:
  name: cilium-test
---
apiVersion: v1
kind: Service
metadata:
  name: backend-svc
  namespace: cilium-test
spec:
  ports:
  - port: 80
  selector:
    app: backend
---
apiVersion: v1
kind: Pod
metadata:
  name: backend
  namespace: cilium-test
  labels:
    app: backend
spec:
  containers:
  - name: nginx
    image: nginx
---
apiVersion: v1
kind: Pod
metadata:
  name: frontend
  namespace: cilium-test
  labels:
    app: frontend
spec:
  containers:
  - name: curl
    image: curlimages/curl
    command: ["sleep", "3600"]
---
apiVersion: v1
kind: Pod
metadata:
  name: hacker
  namespace: cilium-test
  labels:
    app: hacker
spec:
  containers:
  - name: curl
    image: curlimages/curl
    command: ["sleep", "3600"]
            </code></pre>
        </li>
        <li>
            <p>Aplicamos la plantilla anterior:</p>
            <pre><code>kubectl apply -f &lt;fichero-de-la-plantilla-anterior&gt;.yaml</code></pre>
        </li>
        <li>
            <p>Ahora comprobamos la conexión entre <code>frontend</code> y <code>backend</code> de la siguiente manera:</p>
            <pre><code>kubectl exec -t -n cilium-test frontend -- curl -s backend-svc/</code></pre>
        </li>
        <li>
            <p>Comprobemos que el <code>hacker</code> también se conecta:</p>
            <pre><code>kubectl exec -t -n cilium-test hacker -- curl -s backend-svc/</code></pre>
        </li>
        <li>
            <p>La <strong>Cilium Network Policy</strong> para evitar que el <code>hacker</code> nos pueda atacar:</p>
            <pre><code class="language-yaml">
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "require-for-backend"
  namespace: cilium-test
spec:
  # 1. Selecciona el pod 'backend'
  endpointSelector:
    matchLabels:
      app: backend
  # 2. Define la regla de entrada
  ingress:
  - fromEndpoints:
    # 3. Solo permite pods con la etiqueta 'app: frontend'
    - matchLabels:
        app: frontend
            </code></pre>
        </li>
        <li>
            <p>Aplicamos la <strong>Cilium Netwrok Policy</strong></p>
            <pre><code>kubectl apply -f &lt;fichero-de-la-politica-ciliun&gt;.yaml</code></pre>
        </li>
        <li>
            <p>Volvemos a revisar que <code>hacker</code> no nos puede atacar:</p>
            <pre><code>kubectl exec -t -n cilium-test hacker -- curl -s backend-svc/</code></pre>
        </li>
        <li>
            <p>Y para terminar comprobamos que <code>frontend</code> y <code>backend</code> se pueden comunicar:</p>
            <pre><code>kubectl exec -t -n cilium-test frontend -- curl -s backend-svc/</code></pre>
        </li>
        <li>
            <p>Basado en la documentación, modifica el <strong>Cilium Network Policy</strong> para que <code>frontend</code> no pueda hacer ping a <code>backend</code>.</p>
            <p><a href="https://docs.cilium.io/en/stable/security/policy/#network-policy" target="_blank" rel="noopener noreferrer">Documentación</a></p>
        </li>
    </ol>

    <hr>

    <h2>Solución al Ejercicio</h2>

    <!--
      PASO 1: El "placeholder"
      Esto es lo que el usuario verá mientras espera.
    -->
    <div id="respuesta-placeholder">
        <p><strong>¡Espera!</strong> La solución a este desafío aparecerá aquí automáticamente después de <strong>1 hora</strong> desde que cargaste la página.</p>
        <p>Usa este tiempo para intentar resolverlo por tu cuenta. ¡Tú puedes!</p>
    </div>

    <!--
      PASO 2: La respuesta oculta
      Este 'div' está oculto por defecto (style="display: none;")
      El JavaScript lo hará visible cuando pase el tiempo.
    -->
    <div id="respuesta-oculta" style="display: none;">
        <p>¡Aquí está la solución!</p>
        <pre><code class="language-yaml">
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: deny-icmp-allow-http
  namespace: cilium-test
spec:
  endpointSelector:
    matchLabels:
      app: backend

  ingress:
  - fromEndpoints:
    - matchLabels:
        app: frontend
    toPorts:
    - ports:
      - port: "80"
        protocol: TCP

  ingressDeny:
  - fromEntities:
    - "all"
    icmps:
    - fields:
      - type: 8
        family: IPv4
      - type: EchoRequest
        family: IPv6
        </code></pre>
    </div>


    <!--
      PASO 3: El JavaScript
      Este script maneja el temporizador.
    -->
    <script>
        // Función que se ejecutará cuando se complete el temporizador
        function mostrarRespuesta() {
            // Oculta el mensaje de espera
            document.getElementById('respuesta-placeholder').style.display = 'none';
            // Muestra el 'div' que contiene la respuesta
            document.getElementById('respuesta-oculta').style.display = 'block';
        }

        // Define el tiempo de espera: 1 hora en milisegundos
        // (1 hora = 60 minutos * 60 segundos * 1000 milisegundos)
        const unaHoraEnMs = 3600000;

        // Inicia el temporizador
        setTimeout(mostrarRespuesta, unaHoraEnMs);

        // Opcional: puedes descomentar la siguiente línea para probar
        // que funciona con un temporizador corto (ej. 5 segundos)
        // setTimeout(mostrarRespuesta, 5000); 
    </script>

</body>
</html>
